name: Java CI/CD with Docker and Azure Web App

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  DOCKER_REGISTRY: sbrcr.azurecr.io
  IMAGE_REPOSITORY: jsbrimagerepo
  DOCKERFILE_PATH: ./Dockerfile
  DOCKER_NAMESPACE: newNameSpace
  WEB_APP_NAME: jsbrwebapp
  TAG: ${{ github.run_number }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn clean package -DskipTests=false

    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
        password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

    - name: Build Docker image
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPOSITORY }}:${{ env.TAG }}
        context: .
        dockerfile: ${{ env.DOCKERFILE_PATH }}

    - name: Azure Login
      #uses: azure/login@v1
      uses: Azure/cli@v1.0.7
      with:
        creds: ${{ secrets.SERVICE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      #uses: Azure/cli@v1.0.7
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEB_APP_NAME }}
        images: ${{ env.DOCKER_NAMESPACE }}/${{ env.IMAGE_REPOSITORY }}:${{ env.TAG }}
        resource-group: ${{ secrets.AZURE_RESOURCE_GROUP }}
        #login-server: ${{ env.DOCKER_REGISTRY }}
        #username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
        #password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}
